<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>00878 å­˜è‚¡ç´€éŒ„</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --success-dark: #059669;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 40px rgba(0,0,0,0.15);
            --card-radius: 20px;
        }
        
        body {
            font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* å¡ç‰‡åŸºç¤æ¨£å¼ */
        .card {
            background: white;
            border-radius: var(--card-radius);
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--card-shadow);
        }
        
        /* æ¨™é¡Œå¡ç‰‡ */
        .header-card {
            text-align: center;
            padding: 20px 24px;
        }
        
        .stock-name {
            font-size: 22px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .stock-code {
            font-size: 15px;
            color: #9ca3af;
            font-weight: 500;
        }
        
        /* è‚¡åƒ¹å¡ç‰‡ */
        .price-card {
            text-align: center;
            padding: 28px 24px;
        }
        
        .price-label {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .current-price {
            font-size: 56px;
            font-weight: 700;
            color: #1f2937;
            line-height: 1.1;
        }
        
        .price-unit {
            font-size: 22px;
            color: #9ca3af;
            margin-left: 4px;
            font-weight: 500;
        }
        
        .update-time {
            font-size: 13px;
            color: #9ca3af;
            margin-top: 14px;
        }
        
        /* æŒè‚¡è³‡è¨Š */
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .info-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .info-row:first-child {
            padding-top: 0;
        }
        
        .info-label {
            font-size: 16px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .info-value {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }
        
        /* æç›Šå¡ç‰‡ */
        .profit-card {
            padding: 28px 24px;
            text-align: center;
            color: white;
            transition: background 0.3s ease;
        }
        
        .profit-card.positive {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
        }
        
        .profit-card.negative {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
        }
        
        .profit-card.neutral {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }
        
        .profit-label {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .profit-value {
            font-size: 48px;
            font-weight: 700;
            line-height: 1.1;
        }
        
        .profit-rate {
            font-size: 22px;
            margin-top: 10px;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .profit-note {
            font-size: 13px;
            margin-top: 14px;
            opacity: 0.7;
        }
        
        /* è²·é€²ç´€éŒ„å€å¡Š */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .history-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .add-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        .add-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .add-btn:active {
            transform: translateY(0);
        }
        
        /* äº¤æ˜“ç´€éŒ„é …ç›® */
        .history-item {
            background: #f9fafb;
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .history-item:last-child {
            margin-bottom: 0;
        }
        
        .history-item:hover {
            background: #f3f4f6;
        }
        
        .history-main {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .history-info {
            flex: 1;
        }
        
        .history-date {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .history-detail {
            font-size: 16px;
            color: #1f2937;
            font-weight: 600;
        }
        
        .history-price {
            color: #6b7280;
            font-weight: 500;
            margin-left: 8px;
        }
        
        .history-right {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .single-pl {
            font-size: 18px;
            font-weight: 700;
        }
        
        .single-pl.positive {
            color: var(--success);
        }
        
        .single-pl.negative {
            color: var(--danger);
        }
        
        .single-pl.neutral {
            color: #6b7280;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #d1d5db;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 18px;
            line-height: 1;
        }
        
        .delete-btn:hover {
            color: var(--danger);
            background: #fee2e2;
        }
        
        .empty-state {
            text-align: center;
            padding: 32px 16px;
            color: #9ca3af;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .empty-state-text {
            font-size: 15px;
            line-height: 1.5;
        }
        
        /* æ›´æ–°æŒ‰éˆ• */
        .refresh-btn {
            width: 100%;
            padding: 18px;
            background: white;
            border: none;
            border-radius: var(--card-radius);
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 44px rgba(0,0,0,0.18);
        }
        
        .refresh-btn:active {
            transform: translateY(0);
        }
        
        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .refresh-icon {
            font-size: 22px;
            transition: transform 0.3s ease;
        }
        
        .refresh-btn:not(:disabled):hover .refresh-icon {
            transform: rotate(180deg);
        }
        
        /* ç‹€æ…‹è¨Šæ¯ */
        .status-msg {
            text-align: center;
            color: white;
            font-size: 15px;
            margin-top: 16px;
            min-height: 24px;
            font-weight: 500;
        }
        
        /* é å°¾èªªæ˜ */
        .footer-note {
            text-align: center;
            color: rgba(255,255,255,0.75);
            font-size: 13px;
            margin-top: 20px;
            line-height: 1.6;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: white;
            border-radius: var(--card-radius);
            padding: 28px;
            width: 100%;
            max-width: 400px;
            transform: translateY(20px) scale(0.95);
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active .modal {
            transform: translateY(0) scale(1);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s ease;
            -webkit-appearance: none;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .form-hint {
            font-size: 13px;
            color: #9ca3af;
            margin-top: 6px;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        .modal-btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .modal-btn.primary:hover {
            background: var(--primary-dark);
        }
        
        .modal-btn.secondary {
            background: #f3f4f6;
            color: #4b5563;
        }
        
        .modal-btn.secondary:hover {
            background: #e5e7eb;
        }
        
        /* ç¢ºèªåˆªé™¤ Modal */
        .confirm-text {
            text-align: center;
            color: #4b5563;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 8px;
        }
        
        .confirm-detail {
            text-align: center;
            background: #f9fafb;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 8px;
        }
        
        .modal-btn.danger {
            background: var(--danger);
            color: white;
        }
        
        .modal-btn.danger:hover {
            background: var(--danger-dark);
        }

        /* Toast é€šçŸ¥ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #1f2937;
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1001;
        }
        
        .toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œ -->
        <div class="card header-card">
            <div class="stock-name">åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯</div>
            <div class="stock-code">00878</div>
        </div>
        
        <!-- ç›®å‰è‚¡åƒ¹ -->
        <div class="card price-card">
            <div class="price-label">ğŸ“ˆ ç›®å‰è‚¡åƒ¹</div>
            <div>
                <span class="current-price" id="currentPrice">--</span>
                <span class="price-unit">å…ƒ</span>
            </div>
            <div class="update-time" id="updateTime">å°šæœªæ›´æ–°</div>
        </div>
        
        <!-- æŒè‚¡è³‡è¨Š -->
        <div class="card" id="infoCard">
            <div class="info-row">
                <span class="info-label">ğŸ“¦ æŒæœ‰å¼µæ•¸</span>
                <span class="info-value" id="totalShares">0 å¼µ</span>
            </div>
            <div class="info-row">
                <span class="info-label">ğŸ’° ç¸½æˆæœ¬</span>
                <span class="info-value" id="totalCost">0 å…ƒ</span>
            </div>
            <div class="info-row">
                <span class="info-label">ğŸ·ï¸ å¹³å‡è²·åƒ¹</span>
                <span class="info-value" id="avgPrice">0 å…ƒ</span>
            </div>
            <div class="info-row">
                <span class="info-label">ğŸ’µ ç›®å‰å¸‚å€¼</span>
                <span class="info-value" id="marketValue">0 å…ƒ</span>
            </div>
        </div>
        
        <!-- æç›Š -->
        <div class="card profit-card neutral" id="profitCard">
            <div class="profit-label">ğŸ’¹ ç›®å‰æç›Š</div>
            <div class="profit-value" id="profitValue">0 å…ƒ</div>
            <div class="profit-rate" id="profitRate">å ±é…¬ç‡ 0%</div>
            <div class="profit-note">ï¼Šå·²æ‰£é™¤é ä¼°æ‰‹çºŒè²»èˆ‡äº¤æ˜“ç¨…</div>
        </div>
        
        <!-- è²·é€²ç´€éŒ„ -->
        <div class="card">
            <div class="history-header">
                <div class="history-title">ğŸ“ è²·é€²ç´€éŒ„</div>
                <button class="add-btn" onclick="openAddModal()">
                    <span>ï¼‹</span>
                    <span>æ–°å¢</span>
                </button>
            </div>
            <div id="historyList">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- æ›´æ–°æŒ‰éˆ• -->
        <button class="refresh-btn" id="refreshBtn" onclick="fetchPrice()">
            <span class="refresh-icon">ğŸ”„</span>
            <span>æ›´æ–°è‚¡åƒ¹</span>
        </button>
        
        <div class="status-msg" id="statusMsg"></div>
        
        <div class="footer-note">
            è³‡æ–™å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­<br>
            æ¸…é™¤ç€è¦½å™¨è³‡æ–™æœƒéºå¤±ç´€éŒ„
        </div>
    </div>
    
    <!-- æ–°å¢è²·é€² Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-title">æ–°å¢è²·é€²ç´€éŒ„</div>
            <div class="form-group">
                <label class="form-label">è²·é€²æ—¥æœŸ</label>
                <input type="date" class="form-input" id="inputDate">
            </div>
            <div class="form-group">
                <label class="form-label">è²·é€²åƒ¹æ ¼ï¼ˆå…ƒï¼‰</label>
                <input type="number" class="form-input" id="inputPrice" placeholder="ä¾‹å¦‚ï¼š21.35" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">è²·é€²å¼µæ•¸</label>
                <input type="number" class="form-input" id="inputShares" placeholder="ä¾‹å¦‚ï¼š1" min="1" value="1">
                <div class="form-hint">1 å¼µ = 1000 è‚¡</div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button class="modal-btn primary" onclick="addTransaction()">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>
    
    <!-- ç¢ºèªåˆªé™¤ Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-title">ç¢ºèªåˆªé™¤</div>
            <div class="confirm-text">ç¢ºå®šè¦åˆªé™¤é€™ç­†è²·é€²ç´€éŒ„å—ï¼Ÿ</div>
            <div class="confirm-detail" id="deleteDetail"></div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeDeleteModal()">å–æ¶ˆ</button>
                <button class="modal-btn danger" onclick="confirmDelete()">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ===== å¸¸æ•¸è¨­å®š =====
        const FEE_RATE = 0.001425;   // æ‰‹çºŒè²»ç‡
        const TAX_RATE = 0.001;      // äº¤æ˜“ç¨…ç‡
        const STORAGE_KEY = '00878_transactions';
        const PRICE_KEY = '00878_lastPrice';
        const UPDATE_KEY = '00878_lastUpdate';
        
        // ===== ç‹€æ…‹ =====
        let transactions = [];
        let currentPrice = 0;
        let deleteIndex = -1;
        
        // ===== åˆå§‹åŒ– =====
        function init() {
            loadTransactions();
            loadLastPrice();
            renderAll();
            fetchPrice();
            
            // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
            document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
        }
        
        // ===== è³‡æ–™å­˜å– =====
        function loadTransactions() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                transactions = JSON.parse(saved);
                // æŒ‰æ—¥æœŸæ’åºï¼ˆæ–°åˆ°èˆŠï¼‰
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            }
        }
        
        function saveTransactions() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
        }
        
        function loadLastPrice() {
            const saved = localStorage.getItem(PRICE_KEY);
            if (saved) {
                currentPrice = parseFloat(saved);
            }
            const lastUpdate = localStorage.getItem(UPDATE_KEY);
            if (lastUpdate) {
                document.getElementById('updateTime').textContent = 'æ›´æ–°æ™‚é–“ï¼š' + lastUpdate;
            }
        }
        
        function savePrice(price) {
            localStorage.setItem(PRICE_KEY, price);
            const now = new Date();
            const timeStr = formatDateTime(now);
            localStorage.setItem(UPDATE_KEY, timeStr);
            document.getElementById('updateTime').textContent = 'æ›´æ–°æ™‚é–“ï¼š' + timeStr;
        }
        
        // ===== æ ¼å¼åŒ–å·¥å…· =====
        function formatNumber(num) {
            return Math.round(num).toLocaleString('zh-TW');
        }
        
        function formatDateTime(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const h = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            return `${y}/${m}/${d} ${h}:${min}`;
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const w = weekdays[date.getDay()];
            return `${y}/${m}/${d}ï¼ˆé€±${w}ï¼‰`;
        }
        
        // ===== è¨ˆç®—é‚è¼¯ =====
        function calcSummary() {
            const totalShares = transactions.reduce((sum, t) => sum + t.shares, 0);
            const totalCost = transactions.reduce((sum, t) => sum + t.cost, 0);
            const avgPrice = totalShares > 0 ? totalCost / totalShares : 0;
            const marketValue = totalShares * currentPrice;
            
            // é ä¼°è³£å‡ºæˆæœ¬
            const sellFee = Math.floor(marketValue * FEE_RATE);
            const sellTax = Math.floor(marketValue * TAX_RATE);
            const sellCost = sellFee + sellTax;
            
            // æ·¨æç›Š
            const profit = marketValue - totalCost - sellCost;
            const profitRate = totalCost > 0 ? (profit / totalCost) * 100 : 0;
            
            return {
                totalShares,
                totalCost,
                avgPrice,
                marketValue,
                profit,
                profitRate
            };
        }
        
        function calcSinglePL(transaction) {
            return (currentPrice - transaction.price) * transaction.shares;
        }
        
        // ===== ç•«é¢æ¸²æŸ“ =====
        function renderAll() {
            renderSummary();
            renderHistory();
        }
        
        function renderSummary() {
            const summary = calcSummary();
            
            // æ›´æ–°è‚¡åƒ¹
            document.getElementById('currentPrice').textContent = currentPrice > 0 ? currentPrice.toFixed(2) : '--';
            
            // æ›´æ–°æŒè‚¡è³‡è¨Š
            document.getElementById('totalShares').textContent = (summary.totalShares / 1000) + ' å¼µ';
            document.getElementById('totalCost').textContent = formatNumber(summary.totalCost) + ' å…ƒ';
            document.getElementById('avgPrice').textContent = summary.avgPrice > 0 ? summary.avgPrice.toFixed(2) + ' å…ƒ' : '0 å…ƒ';
            document.getElementById('marketValue').textContent = formatNumber(summary.marketValue) + ' å…ƒ';
            
            // æ›´æ–°æç›Šå¡ç‰‡
            const profitCard = document.getElementById('profitCard');
            const isPositive = summary.profit > 0;
            const isNegative = summary.profit < 0;
            
            profitCard.classList.remove('positive', 'negative', 'neutral');
            if (summary.totalShares === 0 || currentPrice === 0) {
                profitCard.classList.add('neutral');
            } else if (isPositive) {
                profitCard.classList.add('positive');
            } else if (isNegative) {
                profitCard.classList.add('negative');
            } else {
                profitCard.classList.add('neutral');
            }
            
            const sign = isPositive ? '+' : '';
            document.getElementById('profitValue').textContent = sign + formatNumber(summary.profit) + ' å…ƒ';
            document.getElementById('profitRate').textContent = 'å ±é…¬ç‡ ' + sign + summary.profitRate.toFixed(2) + '%';
        }
        
        function renderHistory() {
            const container = document.getElementById('historyList');
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <div class="empty-state-text">å°šç„¡è²·é€²ç´€éŒ„<br>é»æ“Šã€Œæ–°å¢ã€é–‹å§‹è¨˜éŒ„</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = transactions.map((t, index) => {
                const pl = calcSinglePL(t);
                const plClass = pl > 0 ? 'positive' : (pl < 0 ? 'negative' : 'neutral');
                const plSign = pl > 0 ? '+' : '';
                const plText = currentPrice > 0 ? `${plSign}${formatNumber(pl)} å…ƒ` : 'è¨ˆç®—ä¸­...';
                
                return `
                    <div class="history-item">
                        <div class="history-main">
                            <div class="history-info">
                                <div class="history-date">${formatDate(t.date)}</div>
                                <div class="history-detail">
                                    è²· ${t.shares / 1000} å¼µ
                                    <span class="history-price">@ ${t.price.toFixed(2)} å…ƒ</span>
                                </div>
                            </div>
                            <div class="history-right">
                                <button class="delete-btn" onclick="openDeleteModal(${index})" title="åˆªé™¤">âœ•</button>
                                <div class="single-pl ${plClass}">${plText}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ===== æ–°å¢äº¤æ˜“ =====
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
            document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('inputPrice').value = '';
            document.getElementById('inputShares').value = '1';
            document.getElementById('inputPrice').focus();
        }
        
        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }
        
        function addTransaction() {
            const date = document.getElementById('inputDate').value;
            const price = parseFloat(document.getElementById('inputPrice').value);
            const shares = parseInt(document.getElementById('inputShares').value) * 1000;
            
            // é©—è­‰
            if (!date) {
                showToast('è«‹é¸æ“‡è²·é€²æ—¥æœŸ');
                return;
            }
            if (!price || price <= 0) {
                showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„è²·é€²åƒ¹æ ¼');
                return;
            }
            if (!shares || shares <= 0) {
                showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„è²·é€²å¼µæ•¸');
                return;
            }
            
            // è¨ˆç®—æˆæœ¬ï¼ˆå«æ‰‹çºŒè²»ï¼‰
            const grossCost = price * shares;
            const fee = Math.floor(grossCost * FEE_RATE);
            const cost = grossCost + fee;
            
            // æ–°å¢
            transactions.push({ date, price, shares, cost });
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            saveTransactions();
            renderAll();
            closeAddModal();
            showToast('âœ… å·²æ–°å¢è²·é€²ç´€éŒ„');
        }
        
        // ===== åˆªé™¤äº¤æ˜“ =====
        function openDeleteModal(index) {
            deleteIndex = index;
            const t = transactions[index];
            document.getElementById('deleteDetail').innerHTML = `
                <div>${formatDate(t.date)}</div>
                <div style="margin-top:4px;font-weight:600;">è²· ${t.shares / 1000} å¼µ @ ${t.price.toFixed(2)} å…ƒ</div>
            `;
            document.getElementById('deleteModal').classList.add('active');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteIndex = -1;
        }
        
        function confirmDelete() {
            if (deleteIndex >= 0) {
                transactions.splice(deleteIndex, 1);
                saveTransactions();
                renderAll();
                showToast('ğŸ—‘ï¸ å·²åˆªé™¤ç´€éŒ„');
            }
            closeDeleteModal();
        }
        
        // ===== è‚¡åƒ¹æ›´æ–° =====
        async function fetchPrice() {
            const btn = document.getElementById('refreshBtn');
            const status = document.getElementById('statusMsg');
            
            btn.disabled = true;
            status.textContent = 'æ­£åœ¨æ›´æ–°è‚¡åƒ¹...';

            const proxies = [
                (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
                (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
            ];
            
            const targetUrl = 'https://tw.stock.yahoo.com/quote/00878.TW';
            let success = false;

            for (let i = 0; i < proxies.length && !success; i++) {
                try {
                    status.textContent = `æ­£åœ¨æ›´æ–°è‚¡åƒ¹... (${i + 1}/${proxies.length})`;
                    
                    const response = await fetch(proxies[i](targetUrl), {
                        signal: AbortSignal.timeout(10000)
                    });
                    const html = await response.text();
                    
                    const priceMatch = html.match(/"regularMarketPrice":(\d+\.?\d*)/);
                    
                    if (priceMatch && priceMatch[1]) {
                        currentPrice = parseFloat(priceMatch[1]);
                        savePrice(currentPrice);
                        renderAll();
                        status.textContent = 'âœ… è‚¡åƒ¹å·²æ›´æ–°';
                        setTimeout(() => { status.textContent = ''; }, 3000);
                        success = true;
                    }
                } catch (error) {
                    console.log(`ä»£ç† ${i + 1} å¤±æ•—:`, error.message);
                }
            }

            if (!success) {
                if (currentPrice > 0) {
                    status.textContent = 'âš ï¸ ç„¡æ³•æ›´æ–°ï¼Œé¡¯ç¤ºä¸Šæ¬¡è‚¡åƒ¹';
                } else {
                    status.textContent = 'âŒ æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                }
            }
            
            btn.disabled = false;
        }
        
        // ===== Toast =====
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }
        
        // ===== é»æ“Šå¤–éƒ¨é—œé–‰ Modal =====
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
        
        // å•Ÿå‹•
        window.onload = init;
    </script>
</body>
</html>
