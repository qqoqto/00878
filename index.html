<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>00878 å­˜è‚¡ç´€éŒ„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Heiti TC", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* æ¨™é¡Œå¡ç‰‡ */
        .header-card {
            background: white;
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            text-align: center;
        }
        
        .stock-name {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .stock-code {
            font-size: 16px;
            color: #888;
        }
        
        /* è‚¡åƒ¹å¤§å¡ç‰‡ */
        .price-card {
            background: white;
            border-radius: 24px;
            padding: 32px 24px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            text-align: center;
        }
        
        .price-label {
            font-size: 18px;
            color: #666;
            margin-bottom: 12px;
        }
        
        .current-price {
            font-size: 64px;
            font-weight: bold;
            color: #333;
            line-height: 1.1;
        }
        
        .price-unit {
            font-size: 24px;
            color: #888;
            margin-left: 4px;
        }
        
        .update-time {
            font-size: 14px;
            color: #aaa;
            margin-top: 16px;
        }
        
        /* æŒè‚¡è³‡è¨Š */
        .info-card {
            background: white;
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #eee;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-size: 18px;
            color: #666;
        }
        
        .info-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        /* æç›Šå¡ç‰‡ - ç‰¹åˆ¥å¼·èª¿ */
        .profit-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            border-radius: 24px;
            padding: 32px 24px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            text-align: center;
            color: white;
        }
        
        .profit-card.positive {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }
        
        .profit-card.negative {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
        }
        
        .profit-label {
            font-size: 20px;
            opacity: 0.9;
            margin-bottom: 12px;
        }
        
        .profit-value {
            font-size: 56px;
            font-weight: bold;
            line-height: 1.1;
        }
        
        .profit-rate {
            font-size: 24px;
            margin-top: 12px;
            opacity: 0.9;
        }
        
        .profit-note {
            font-size: 14px;
            margin-top: 16px;
            opacity: 0.7;
        }
        
        /* æ›´æ–°æŒ‰éˆ• */
        .refresh-btn {
            width: 100%;
            padding: 20px;
            background: white;
            border: none;
            border-radius: 24px;
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            cursor: pointer;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .refresh-btn:active {
            transform: scale(0.98);
        }
        
        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .refresh-icon {
            font-size: 24px;
        }
        
        /* ç‹€æ…‹è¨Šæ¯ */
        .status-msg {
            text-align: center;
            color: white;
            font-size: 16px;
            margin-top: 16px;
            min-height: 24px;
        }
        
        /* è²·é€²ç´€éŒ„ */
        .history-card {
            background: white;
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        
        .history-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .history-item {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .history-item:last-child {
            margin-bottom: 0;
        }
        
        .history-date {
            font-size: 16px;
            color: #888;
            margin-bottom: 8px;
        }
        
        .history-detail {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
        }
        
        .history-shares {
            color: #333;
            font-weight: bold;
        }
        
        .history-price {
            color: #666;
        }
        
        .single-pl {
            margin-top: 8px;
            font-size: 18px;
            font-weight: bold;
            text-align: right;
        }
        
        .single-pl.positive {
            color: #40c057;
        }
        
        .single-pl.negative {
            color: #ee5a5a;
        }

        /* é å°¾èªªæ˜ */
        .footer-note {
            text-align: center;
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            margin-top: 24px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œ -->
        <div class="header-card">
            <div class="stock-name">åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯</div>
            <div class="stock-code">00878</div>
        </div>
        
        <!-- ç›®å‰è‚¡åƒ¹ -->
        <div class="price-card">
            <div class="price-label">ğŸ“ˆ ç›®å‰è‚¡åƒ¹</div>
            <div>
                <span class="current-price" id="currentPrice">21.35</span>
                <span class="price-unit">å…ƒ</span>
            </div>
            <div class="update-time" id="updateTime">æ›´æ–°æ™‚é–“ï¼šè¼‰å…¥ä¸­...</div>
        </div>
        
        <!-- æŒè‚¡è³‡è¨Š -->
        <div class="info-card">
            <div class="info-row">
                <span class="info-label">ğŸ“¦ æŒæœ‰å¼µæ•¸</span>
                <span class="info-value">2 å¼µ</span>
            </div>
            <div class="info-row">
                <span class="info-label">ğŸ’° ç¸½æˆæœ¬</span>
                <span class="info-value">42,440 å…ƒ</span>
            </div>
            <div class="info-row">
                <span class="info-label">ğŸ·ï¸ å¹³å‡è²·åƒ¹</span>
                <span class="info-value">21.22 å…ƒ</span>
            </div>
            <div class="info-row">
                <span class="info-label">ğŸ’µ ç›®å‰å¸‚å€¼</span>
                <span class="info-value" id="marketValue">42,700 å…ƒ</span>
            </div>
        </div>
        
        <!-- æç›Š - æœ€é‡è¦çš„è³‡è¨Š -->
        <div class="profit-card" id="profitCard">
            <div class="profit-label">ğŸ’¹ ç›®å‰æç›Š</div>
            <div class="profit-value" id="profitValue">+158 å…ƒ</div>
            <div class="profit-rate" id="profitRate">å ±é…¬ç‡ +0.37%</div>
            <div class="profit-note">ï¼Šå·²æ‰£é™¤é ä¼°æ‰‹çºŒè²»èˆ‡äº¤æ˜“ç¨…</div>
        </div>
        
        <!-- è²·é€²ç´€éŒ„ -->
        <div class="history-card">
            <div class="history-title">ğŸ“ è²·é€²ç´€éŒ„</div>
            
            <div class="history-item">
                <div class="history-date">2025/12/16ï¼ˆé€±äºŒï¼‰</div>
                <div class="history-detail">
                    <span class="history-shares">è²· 1 å¼µ</span>
                    <span class="history-price">@ 21.10 å…ƒ</span>
                </div>
                <div class="single-pl" id="singlePL2">æç›Šè¨ˆç®—ä¸­...</div>
            </div>
            
            <div class="history-item">
                <div class="history-date">2025/12/11ï¼ˆé€±å››ï¼‰</div>
                <div class="history-detail">
                    <span class="history-shares">è²· 1 å¼µ</span>
                    <span class="history-price">@ 21.30 å…ƒ</span>
                </div>
                <div class="single-pl" id="singlePL1">æç›Šè¨ˆç®—ä¸­...</div>
            </div>
        </div>
        
        <!-- æ›´æ–°æŒ‰éˆ• -->
        <button class="refresh-btn" id="refreshBtn" onclick="fetchPrice()">
            <span class="refresh-icon">ğŸ”„</span>
            <span>æ›´æ–°è‚¡åƒ¹</span>
        </button>
        
        <div class="status-msg" id="statusMsg"></div>
        
        <div class="footer-note">
            æ¯æ¬¡é–‹å•Ÿæœƒè‡ªå‹•æ›´æ–°è‚¡åƒ¹<br>
            ä¹Ÿå¯ä»¥æŒ‰ä¸Šæ–¹æŒ‰éˆ•æ‰‹å‹•æ›´æ–°
        </div>
    </div>

    <script>
        // ===== å­˜è‚¡è³‡æ–™è¨­å®š =====
        const stockData = {
            stockCode: '00878',
            totalShares: 2000,      // ç¸½è‚¡æ•¸
            totalCost: 42440,       // ç¸½æˆæœ¬
            totalDividend: 0,       // ç´¯è¨ˆè‚¡åˆ©
            totalFee: 40,           // ç´¯è¨ˆæ‰‹çºŒè²»
            feeRate: 0.001425,      // æ‰‹çºŒè²»ç‡
            taxRate: 0.001,         // äº¤æ˜“ç¨…ç‡
            transactions: [
                { date: '2025-12-11', cost: 21320, price: 21.3, shares: 1000 },
                { date: '2025-12-16', cost: 21120, price: 21.1, shares: 1000 }
            ]
        };

        stockData.avgCost = (stockData.totalCost / stockData.totalShares).toFixed(2);

        // è¨ˆç®—é ä¼°è³£å‡ºæˆæœ¬
        function calcSellCost(marketValue) {
            const sellFee = Math.floor(marketValue * stockData.feeRate);
            const sellTax = Math.floor(marketValue * stockData.taxRate);
            return { sellFee, sellTax, total: sellFee + sellTax };
        }

        // æ ¼å¼åŒ–æ•¸å­—
        function formatNumber(num) {
            return num.toLocaleString('zh-TW');
        }

        // æ›´æ–°ç•«é¢
        function updateDisplay(price) {
            const currentPrice = parseFloat(price);
            const marketValue = Math.round(currentPrice * stockData.totalShares);
            const grossUnrealizedPL = marketValue - stockData.totalCost;
            
            // æ‰£é™¤é ä¼°è³£å‡ºæˆæœ¬
            const sellCost = calcSellCost(marketValue);
            const unrealizedPL = grossUnrealizedPL - sellCost.total;
            
            const profitPercent = ((unrealizedPL / stockData.totalCost) * 100).toFixed(2);
            const isPositive = unrealizedPL >= 0;

            // æ›´æ–°è‚¡åƒ¹
            document.getElementById('currentPrice').textContent = currentPrice.toFixed(2);
            
            // æ›´æ–°å¸‚å€¼
            document.getElementById('marketValue').textContent = formatNumber(marketValue) + ' å…ƒ';
            
            // æ›´æ–°æç›Šå¡ç‰‡
            const profitCard = document.getElementById('profitCard');
            profitCard.className = 'profit-card ' + (isPositive ? 'positive' : 'negative');
            
            const sign = isPositive ? '+' : '';
            document.getElementById('profitValue').textContent = sign + formatNumber(unrealizedPL) + ' å…ƒ';
            document.getElementById('profitRate').textContent = 'å ±é…¬ç‡ ' + sign + profitPercent + '%';
            
            // æ›´æ–°å–®ç­†æç›Š
            stockData.transactions.forEach((t, index) => {
                const singlePL = Math.round((currentPrice - t.price) * t.shares);
                const el = document.getElementById('singlePL' + (index + 1));
                if (el) {
                    const singleSign = singlePL >= 0 ? '+' : '';
                    el.textContent = singleSign + formatNumber(singlePL) + ' å…ƒ';
                    el.className = 'single-pl ' + (singlePL >= 0 ? 'positive' : 'negative');
                }
            });

            // æ›´æ–°æ™‚é–“
            const now = new Date();
            const timeStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            document.getElementById('updateTime').textContent = 'æ›´æ–°æ™‚é–“ï¼š' + timeStr;

            // å„²å­˜åˆ°æœ¬åœ°
            localStorage.setItem('00878_lastPrice', currentPrice);
            localStorage.setItem('00878_lastUpdate', timeStr);
        }

        // æŠ“å–è‚¡åƒ¹ - å¤šå€‹å‚™ç”¨ä¾†æº
        async function fetchPrice() {
            const btn = document.getElementById('refreshBtn');
            const status = document.getElementById('statusMsg');
            
            btn.disabled = true;
            status.textContent = 'æ­£åœ¨æ›´æ–°è‚¡åƒ¹...';

            // å¤šå€‹ä»£ç†æœå‹™å‚™ç”¨
            const proxies = [
                (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
                (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
            ];
            
            const targetUrl = 'https://tw.stock.yahoo.com/quote/00878.TW';
            let success = false;

            for (let i = 0; i < proxies.length && !success; i++) {
                try {
                    status.textContent = `æ­£åœ¨æ›´æ–°è‚¡åƒ¹... (${i + 1}/${proxies.length})`;
                    
                    const response = await fetch(proxies[i](targetUrl), {
                        signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ™‚
                    });
                    const html = await response.text();
                    
                    const priceMatch = html.match(/"regularMarketPrice":(\d+\.?\d*)/);
                    
                    if (priceMatch && priceMatch[1]) {
                        const price = parseFloat(priceMatch[1]);
                        updateDisplay(price);
                        status.textContent = 'âœ… è‚¡åƒ¹å·²æ›´æ–°';
                        setTimeout(() => { status.textContent = ''; }, 3000);
                        success = true;
                    }
                } catch (error) {
                    console.log(`ä»£ç† ${i + 1} å¤±æ•—:`, error.message);
                }
            }

            if (!success) {
                console.error('æ‰€æœ‰ä»£ç†éƒ½å¤±æ•—');
                const lastPrice = localStorage.getItem('00878_lastPrice');
                if (lastPrice) {
                    updateDisplay(parseFloat(lastPrice));
                    status.textContent = 'âš ï¸ ç„¡æ³•æ›´æ–°ï¼Œé¡¯ç¤ºä¸Šæ¬¡è‚¡åƒ¹';
                } else {
                    status.textContent = 'âŒ æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                }
            }
            
            btn.disabled = false;
        }

        // é é¢è¼‰å…¥
        window.onload = function() {
            // å…ˆé¡¯ç¤ºå¿«å–çš„åƒ¹æ ¼
            const lastPrice = localStorage.getItem('00878_lastPrice');
            if (lastPrice) {
                updateDisplay(parseFloat(lastPrice));
                const lastUpdate = localStorage.getItem('00878_lastUpdate');
                if (lastUpdate) {
                    document.getElementById('updateTime').textContent = 'æ›´æ–°æ™‚é–“ï¼š' + lastUpdate;
                }
            }
            // è‡ªå‹•æŠ“å–æœ€æ–°è‚¡åƒ¹
            fetchPrice();
        };
    </script>
</body>
</html>
