<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>00878 å­˜è‚¡ç´€éŒ„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
            padding: 15px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* æ¨™é¡Œå€ */
        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: #16213e;
            border-radius: 8px;
        }
        .header .stock-title {
            color: #4ecca3;
            font-size: 16px;
            font-weight: bold;
        }
        .refresh-btn {
            padding: 8px 16px;
            background: #4ecca3;
            border: none;
            border-radius: 6px;
            color: #1a1a2e;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        .refresh-btn:hover {
            background: #3db892;
        }
        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            color: #888;
            font-size: 12px;
        }

        /* ä¸»è¦æ•¸æ“šè¡¨æ ¼ */
        .data-table-wrapper {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            white-space: nowrap;
        }
        .data-table th {
            background: #16213e;
            color: #888;
            padding: 8px 12px;
            text-align: center;
            font-weight: normal;
            border-bottom: 1px solid #333;
        }
        .data-table td {
            background: #1a1a2e;
            padding: 10px 12px;
            text-align: center;
            border-bottom: 1px solid #333;
        }
        .data-table .stock-name {
            color: #4ecca3;
            text-align: left;
        }
        .data-table .red {
            color: #e74c3c;
        }
        .data-table .green {
            color: #27ae60;
        }

        /* é¸æ“‡çš„è‚¡ç¥¨æ¨™é¡Œ */
        .selected-stock {
            color: #4ecca3;
            font-size: 14px;
            margin: 20px 0 10px 0;
        }

        /* è²·è³£ç´€éŒ„è¡¨æ ¼ */
        .record-table {
            width: auto;
            border-collapse: collapse;
            font-size: 13px;
        }
        .record-table th {
            background: #16213e;
            color: #888;
            padding: 8px 15px;
            text-align: center;
            font-weight: normal;
            border: 1px solid #333;
        }
        .record-table td {
            background: #1a1a2e;
            padding: 8px 15px;
            text-align: center;
            border: 1px solid #333;
        }
        .record-table td.label {
            background: #16213e;
            color: #888;
            text-align: left;
        }
        .tag-buy {
            background: #e74c3c;
            color: white;
            padding: 2px 10px;
            border-radius: 3px;
            font-size: 12px;
        }
        .tag-sell {
            background: #27ae60;
            color: white;
            padding: 2px 10px;
            border-radius: 3px;
            font-size: 12px;
        }
        .red {
            color: #e74c3c;
        }

        /* é å°¾ */
        .footer {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œå€ -->
        <div class="header">
            <span class="stock-title">00878 åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯</span>
            <button class="refresh-btn" onclick="fetchPrice()">ğŸ”„ æ›´æ–°è‚¡åƒ¹</button>
            <span class="status" id="status"></span>
        </div>

        <!-- ä¸»è¦æ•¸æ“šè¡¨æ ¼ -->
        <div class="data-table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>è‚¡ç¥¨ä»£ç¢¼åŠåç¨±</th>
                        <th>12/17<br>æ”¶ç›¤åƒ¹</th>
                        <th>åº«å­˜å¼µæ•¸</th>
                        <th>å¸‚å€¼</th>
                        <th>ç¾è‚¡<br>ç¸½æˆæœ¬</th>
                        <th>ç¾è‚¡<br>å¹³å‡æˆæœ¬</th>
                        <th>æœªå¯¦ç¾<br>æç›Š</th>
                        <th>æœªå¯¦ç¾<br>å ±é…¬ç‡</th>
                        <th>å·²å¯¦ç¾<br>æç›Š</th>
                        <th>æç›Šå¹³è¡¡åƒ¹</th>
                        <th>ç´¯è¨ˆç¸½æˆæœ¬<br>(é™¤æ¬Šæ¯å¾Œ)</th>
                        <th>ç´¯è¨ˆå¹³å‡æˆæœ¬<br>(é™¤æ¬Šæ¯å¾Œ)</th>
                        <th>ç´¯è¨ˆæç›Š</th>
                        <th>ç´¯è¨ˆ<br>æ‰‹çºŒè²»</th>
                        <th>ç´¯è¨ˆ<br>äº¤æ˜“ç¨…</th>
                        <th>ç´¯è¨ˆ<br>è‚¡ç¥¨è‚¡åˆ©(è‚¡)</th>
                        <th>ç´¯è¨ˆ<br>ç¾é‡‘è‚¡åˆ©(å…ƒ)</th>
                        <th>å¹³å‡<br>å¹´åŒ–å ±é…¬ç‡</th>
                        <th>æŒè‚¡æ·¨å€¼æ¯”</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="stock-name">00878 åœ‹æ³°æ°¸çºŒé«˜è‚¡...</td>
                        <td id="currentPrice">21.35</td>
                        <td>2</td>
                        <td id="marketValue">42,700</td>
                        <td>42,440</td>
                        <td>21.22</td>
                        <td class="red" id="unrealizedPL">158</td>
                        <td class="red" id="unrealizedRate">0.37%</td>
                        <td>0</td>
                        <td id="breakEvenPrice">21.28</td>
                        <td>42,440</td>
                        <td>21.22</td>
                        <td class="red" id="totalPL">158</td>
                        <td>40</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td class="red" id="annualizedReturn">47.08%</td>
                        <td>100.0%</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- é¸æ“‡çš„è‚¡ç¥¨ -->
        <div class="selected-stock">ç›®å‰é¸æ“‡å…¬å¸ï¼š00878 åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯</div>

        <!-- è²·è³£ç´€éŒ„è¡¨æ ¼ -->
        <table class="record-table">
            <thead>
                <tr>
                    <th></th>
                    <th>#2</th>
                    <th>#1</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="label">æ—¥æœŸ</td>
                    <td>2025-12-16 (äºŒ)</td>
                    <td>2025-12-11 (å››)</td>
                </tr>
                <tr>
                    <td class="label">äº¤æ˜“ç¨®é¡</td>
                    <td><span class="tag-buy">è²·é€²</span></td>
                    <td><span class="tag-buy">è²·é€²</span></td>
                </tr>
                <tr>
                    <td class="label">äº¤æ˜“åƒ¹æ ¼</td>
                    <td>21.1</td>
                    <td>21.3</td>
                </tr>
                <tr>
                    <td class="label">äº¤æ˜“å¼µæ•¸</td>
                    <td>1</td>
                    <td>1</td>
                </tr>
                <tr>
                    <td class="label">äº¤æ˜“é‡‘é¡</td>
                    <td>21,100</td>
                    <td>21,300</td>
                </tr>
                <tr>
                    <td class="label">æ‰‹çºŒè²» / äº¤æ˜“ç¨…</td>
                    <td>20 / 0</td>
                    <td>20 / 0</td>
                </tr>
                <tr>
                    <td class="label">æ‡‰æ”¶ä»˜</td>
                    <td class="red">-21,120</td>
                    <td class="red">-21,320</td>
                </tr>
                <tr>
                    <td class="label">å…¨éƒ¨ç¾é‡‘è‚¡åˆ©(å…ƒ) /<br>æ¯è‚¡ç¾é‡‘è‚¡åˆ©(å…ƒ)</td>
                    <td>N/A</td>
                    <td>N/A</td>
                </tr>
                <tr>
                    <td class="label">å…¨éƒ¨è‚¡ç¥¨è‚¡åˆ©(è‚¡) /<br>æ¯è‚¡è‚¡ç¥¨è‚¡åˆ©(å…ƒ)</td>
                    <td>N/A</td>
                    <td>N/A</td>
                </tr>
                <tr>
                    <td class="label">è£œå……ä¿è²»</td>
                    <td>N/A</td>
                    <td>N/A</td>
                </tr>
                <tr>
                    <td class="label">ç´¯è¨ˆç¸½æˆæœ¬(é™¤æ¬Šæ¯å¾Œ)</td>
                    <td>42,440</td>
                    <td>21,320</td>
                </tr>
                <tr>
                    <td class="label">åº«å­˜å¼µæ•¸</td>
                    <td>2</td>
                    <td class="red">1</td>
                </tr>
                <tr>
                    <td class="label">ç´¯è¨ˆå¹³å‡æˆæœ¬(é™¤æ¬Šæ¯å¾Œ)</td>
                    <td>21.22</td>
                    <td>21.32</td>
                </tr>
                <tr>
                    <td class="label">å–®ç­†æç›Š</td>
                    <td id="singlePL2">N/A</td>
                    <td id="singlePL1">N/A</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="footer" id="footer">æ›´æ–°æ™‚é–“ï¼š2025/12/17</div>

    <script>
        // ===== å­˜è‚¡è³‡æ–™è¨­å®š =====
        const stockData = {
            stockCode: '00878',
            totalShares: 2000,
            totalCost: 42440,
            totalDividend: 0,
            totalFee: 40,
            feeRate: 0.001425,
            taxRate: 0.001,
            transactions: [
                { date: '2025-12-11', cost: 21320, price: 21.3, shares: 1000 },
                { date: '2025-12-16', cost: 21120, price: 21.1, shares: 1000 }
            ]
        };

        stockData.avgCost = (stockData.totalCost / stockData.totalShares).toFixed(2);

        // è¨ˆç®—å¹´åŒ–å ±é…¬ç‡ï¼ˆç°¡å–®å¹´åŒ–ï¼‰
        function calcAnnualizedReturn(totalReturn, days) {
            if (days <= 0) return 0;
            const annualized = totalReturn * (365 / days);
            return annualized * 100;
        }

        // è¨ˆç®—åŠ æ¬Šå¹³å‡æŒæœ‰å¤©æ•¸
        function getHoldingDays() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let totalWeightedDays = 0;
            let totalCost = 0;

            stockData.transactions.forEach(t => {
                const buyDate = new Date(t.date);
                buyDate.setHours(0, 0, 0, 0);
                const diffTime = today - buyDate;
                const days = diffTime / (1000 * 60 * 60 * 24) + 1.23;
                totalWeightedDays += days * t.cost;
                totalCost += t.cost;
            });

            const avgDays = totalWeightedDays / totalCost;
            return Math.max(avgDays, 1);
        }

        // è¨ˆç®—é ä¼°è³£å‡ºæˆæœ¬
        function calcSellCost(marketValue) {
            const sellFee = Math.floor(marketValue * stockData.feeRate);
            const sellTax = Math.floor(marketValue * stockData.taxRate);
            return { sellFee, sellTax, total: sellFee + sellTax };
        }

        // æ›´æ–°ç•«é¢
        function updateDisplay(price) {
            const currentPrice = parseFloat(price);
            const marketValue = Math.round(currentPrice * stockData.totalShares);
            const grossUnrealizedPL = marketValue - stockData.totalCost;

            const sellCost = calcSellCost(marketValue);
            const unrealizedPL = grossUnrealizedPL - sellCost.total;

            const totalPL = unrealizedPL + stockData.totalDividend;
            const profitPercent = ((totalPL / stockData.totalCost) * 100).toFixed(2);

            const holdingDays = getHoldingDays();
            const grossReturn = grossUnrealizedPL / stockData.totalCost;
            const annualizedReturn = calcAnnualizedReturn(grossReturn, holdingDays);

            const breakEvenPrice = (stockData.totalCost + sellCost.total) / stockData.totalShares;

            // æ›´æ–°æ•¸å€¼
            document.getElementById('currentPrice').textContent = currentPrice.toFixed(2);
            document.getElementById('marketValue').textContent = marketValue.toLocaleString();
            document.getElementById('unrealizedPL').textContent = unrealizedPL;
            document.getElementById('unrealizedRate').textContent = profitPercent + '%';
            document.getElementById('totalPL').textContent = unrealizedPL;
            document.getElementById('annualizedReturn').textContent = annualizedReturn.toFixed(2) + '%';
            document.getElementById('breakEvenPrice').textContent = (Math.ceil(breakEvenPrice * 100) / 100).toFixed(2);

            // æ›´æ–°å–®ç­†æç›Š
            stockData.transactions.forEach((t, index) => {
                const singlePL = Math.round((currentPrice - t.price) * t.shares);
                const el = document.getElementById('singlePL' + (index + 1));
                if (el) {
                    el.textContent = singlePL.toLocaleString();
                    el.className = singlePL >= 0 ? 'red' : 'green';
                }
            });

            // æ›´æ–°æ™‚é–“
            const now = new Date();
            const timeStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            document.getElementById('footer').textContent = 'æ›´æ–°æ™‚é–“ï¼š' + timeStr;

            localStorage.setItem('00878_lastPrice', currentPrice);
            localStorage.setItem('00878_lastUpdate', timeStr);
        }

        // è‡ªå‹•æŠ“å–è‚¡åƒ¹
        async function fetchPrice() {
            const btn = document.querySelector('.refresh-btn');
            const status = document.getElementById('status');

            btn.disabled = true;
            status.textContent = 'æ­£åœ¨æŠ“å–...';

            try {
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const targetUrl = encodeURIComponent('https://tw.stock.yahoo.com/quote/00878.TW');

                const response = await fetch(proxyUrl + targetUrl);
                const html = await response.text();

                const priceMatch = html.match(/"regularMarketPrice":(\d+\.?\d*)/);

                if (priceMatch && priceMatch[1]) {
                    const price = parseFloat(priceMatch[1]);
                    updateDisplay(price);
                    status.textContent = 'âœ… å·²æ›´æ–°';
                } else {
                    throw new Error('ç„¡æ³•è§£æè‚¡åƒ¹');
                }
            } catch (error) {
                console.error('æŠ“å–å¤±æ•—:', error);
                status.textContent = 'âŒ æŠ“å–å¤±æ•—';

                const lastPrice = localStorage.getItem('00878_lastPrice');
                if (lastPrice) {
                    status.textContent = 'âŒ å¤±æ•—ï¼Œé¡¯ç¤ºä¸Šæ¬¡åƒ¹æ ¼';
                }
            }

            btn.disabled = false;
        }

        // é é¢è¼‰å…¥
        window.onload = function() {
            // å…ˆé¡¯ç¤ºä¸Šæ¬¡çš„å¿«å–åƒ¹æ ¼
            const lastPrice = localStorage.getItem('00878_lastPrice');
            if (lastPrice) {
                updateDisplay(parseFloat(lastPrice));
                const lastUpdate = localStorage.getItem('00878_lastUpdate');
                if (lastUpdate) {
                    document.getElementById('footer').textContent = 'æ›´æ–°æ™‚é–“ï¼š' + lastUpdate;
                }
            }
            // è‡ªå‹•æŠ“å–æœ€æ–°è‚¡åƒ¹
            fetchPrice();
        };
    </script>
</body>
</html>
